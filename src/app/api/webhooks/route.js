import { NextResponse } from "next/server";
import { clients } from '@/app/api/event/route';

// API-—Ä–æ—É—Ç –¥–ª—è –ø—Ä–∏–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç –≤–µ–±—Ö—É–∫–æ–≤ Strapi
export async function POST(request) {
  try {
    // –ß–∏—Ç–∞–µ–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–∫ JSON –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ –Ω–æ–≤–æ–º –¢–ù
    const payload = await request.json();
    // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–∞
    console.log("üì¨ –í–µ–±—Ö—É–∫: –ø–æ–ª—É—á–µ–Ω POST-–∑–∞–ø—Ä–æ—Å –æ—Ç Strapi");
    console.log("üì¶ –ü–æ–ª–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞:", JSON.stringify(payload, null, 2));

    // —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¢–ù
    // if (payload.model !== "api::tn.tn") {
    //   console.log("‚ö†Ô∏è –í–µ–±—Ö—É–∫: —ç—Ç–æ –Ω–µ –¢–ù, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
    //   return NextResponse.json({ skipped: true }, { status: 200 });
    // }
    console.log("üîç –í–µ–±—Ö—É–∫: –º–æ–¥–µ–ª—å –∑–∞–ø–∏—Å–∏ =", payload.model);
    console.log("‚úîÔ∏è –¢–ù —Å–æ–±—ã—Ç–∏–µ:", payload.event);

    // üîî –†–∞—Å—Å—ã–ª–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ –≤—Å–µ–º SSE-–∫–ª–∏–µ–Ω—Ç–∞–º
    for (const [clientId, writer] of clients) {
      writer.write(`event: message\n`);
      writer.write(`data: ${JSON.stringify(payload)}\n\n`);
    }

    return NextResponse.json(
      { message: "–í–µ–±—Ö—É–∫ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç" },
      { status: 200 }
    );
  } catch (error) {
    // –õ–æ–≥–∏—Ä—É–µ–º –≤–æ–∑–Ω–∏–∫—à—É—é –æ—à–∏–±–∫—É
    console.error("‚ùóÔ∏è –í–µ–±—Ö—É–∫: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ POST-–∑–∞–ø—Ä–æ—Å–∞:", error);
    return NextResponse.json(
      { error: "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–∞" },
      { status: 500 }
    );
  }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞ –≤–µ–±—Ö—É–∫–∞ (health check)
export async function GET() {
  console.log("üîç –í–µ–±—Ö—É–∫: –ø–æ–ª—É—á–µ–Ω GET-–∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ç–∞—Ç—É—Å–∞");
  return NextResponse.json(
    { message: "–≠–Ω–¥–ø–æ–∏–Ω—Ç –≤–µ–±—Ö—É–∫–∞ –¥–æ—Å—Ç—É–ø–µ–Ω" },
    { status: 200 }
  );
}
